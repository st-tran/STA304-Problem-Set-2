---
title: "Predicting probability of life satisfaction level among adult Canadians with multiple factors in life"
author: "Steven Tran, Nayoung Kim"
date: "October 19th 2020"
output: pdf_document
header-includes: 
    - \usepackage{tabularx}
    - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(survey)
library(tidyverse)
library(dplyr)
library(knitr)
library(kableExtra)
library(plot3D)
library(tab)
```

## Abstract

    This report analyzes how mature Canadians feel about their life, provided certain factors in life. Deriving data from the 2017 General Social Survey, this analysis utilizes a dependent variable that has two categorical levels- whether the respondent individual answered feeling generally happy, or the respondent was overall not content with life. Income of the respondent illustrated to play a role in influencing the life rating, whereas other factors in life did not portray a significance in affecting the rating. This was a meaningful discovery as higher income was found to be associated with higher life happiness level in general.   

## Introduction

Here is where you should give insight into the setting and introduce the goal of the analysis. Here you can introduce ideas and basic concepts regarding the study setting and the potential model. Again, this is the introduction, so you should be explaining the importance of the work that is ahead and hopefully build some suspense for the reader. You can also highlight what will be included in the subsequent sections.

    The goal of this analysis is to discover a relationship between the outcome variable of contentness of life and the auxiliary variables of factors in life by utilizing a logistic regression model. In this analysis, the study variable is feelings about life, and five auxiliary variables were selected to test if they indeed have a relationship with the outcome variable. Feelings about life were measured as generally happy if the rating was five or higher out of 10, while they were grouped as overall not content if the rating was lower than 5. The chosen dependent variables are age at first birth, current age of the respondent, income of the respondent, place of birth whether it is within or ouside of Canada, and future intention of having any children. While there were numerous variables in the data that were available to select, these five specific variables were intuitively picked to check the hypothesis that these will have an association with life rating. The importance of the work is that through the logistic regression model, an analysis can be built about how adult individuals in Canada feel about their life, considering the input variables. More precisely, the probability of an adult Canadian having a contented life can be calculated. Ultimately, the main goal is to observe if any of these life factors affect life rating, and if so, how large the influence is. In the subsequent sections, the model section is covered and explained using tables and the results section through a graph, while weaknesses and next steps are also discussed.

## Data

Introduce the data, explain why it was selected. Make sure to comment on important features and highlight any potential drawbacks to the data.

The selected output variable is feelings about life, and the auxiliary variables are age of the respondent, age at first birth, place of birth (whether it was in Canada or not), income of the respondent, and intention of having future children. We chose this study variable in the intent to scrutinize the life satisfaction rating of Canadians, whether this is dependent on certain factors in life. Also, we decided on the specific input variables because intuitively, they are the most suitable data for our hypothesis and to prove that indeed, there is a linear relationship between the y and x variables. A drawback to the data is that because of the numerous 'NA' responses, our population data size greatly decreased from the original sampled population number. Another drawback to the data is that there are numerous vague responses such as "Don't know" or "Unsure", which are difficult to place in order.


## Model

Introduce the selected model here. It is expected that you will use some mathematical notation here. If you do please ensure that all notation is explained. You may also want to discuss any special (hypothetical) cases of your model here, as well as any caveats.


```{r include=FALSE, echo=FALSE, warning=FALSE}
can_pop_stats <- read.csv("popstats.csv", nrows=15) %>% 
    select(province=Geographic.name, population=Population..2016) %>% 
    filter(!(province %in% c("Canada", "Yukon", "Northwest Territories", "Nunavut", "")))

gss_full <- read.csv("gss.csv")

gss = gss_full %>% # Select only the variables that are used in our model
    select(c(
             province,
             feelings_life,
             age,
             income_respondent,
             place_birth_canada,
             age_at_first_birth,
             future_children_intention)) %>% drop_na
#gss_full$future_children_intention[is.na(gss_full$future_children_intention)] <- "Don't know"
#gss = gss_full %>% # Select only the variables that are used in our model
#    select(c(
#             province,
#             feelings_life,
#             age,
#             income_respondent,
#             place_birth_canada,
#             age_at_first_birth,
#             future_children_intention)) %>%
#replace_na(list(
#                "",
#                0, 
#                0,
#                "Less than $25,000",
#                "Don't know",
#                0,
#                "Don't know"
#                )) %>%
#drop_na() # Remove the NA values

# Perform inner join on 'province' for finite population correction
gss <- inner_join(gss, can_pop_stats, by="province")

# Convert some columns we'll be using as dummy variables to be ordered factors
gss$income_respondent <- factor(gss$income_respondent, levels=c(
    "Less than $25,000",
    "$25,000 to $49,999",
    "$50,000 to $74,999",
    "$75,000 to $99,999",
    "$100,000 to $ 124,999",
    "$125,000 and more"
))
gss$place_birth_canada <- factor(gss$place_birth_canada, levels=c(
    "Don't know",
    "Born outside Canada",
    "Born in Canada"
))
gss$future_children_intention <- factor(gss$future_children_intention, levels=c(
    "Don't know",
    "No, definitely not",
    "Probably not",
    "Unsure",
    "Probably yes",
    "Definitely yes"
))
```

To predict the probability of a person being happy, which we define as:
$$ \text{Prob}(h):= \begin{cases}1, &\text{if feelings\_life}\geq 6 \\ 0, &\text{otherwise}\end{cases} $$
we fit a logistic regression model with some independent/predictor variables.

```{r}
data.frame(
           gss$income_respondent %>% sort %>% unique,
           gss$future_children_intention %>% sort %>% unique,
           c(as.vector(gss$place_birth_canada %>% sort %>% unique), rep("", 3))
           ) %>% kable(col.names=c(
                                   "Income of Respondent",
                                   "Future Children Intention",
                                   "Born in Canada?"
                                   ),
                       caption="Categorical Variables") %>% column_spec(1:3) %>% kable_styling(
                       latex_options="hold_position"
)
```

The other predictor variables are `age_at_first_birth` and `age`.

<!--```{r, fig.align='center'}
scatter3D(
          x=gss$age_at_first_birth, 
          y=gss$age, 
          z=gss$feelings_life, 
          bty="b2", 
          theta=50, 
          phi=40, 
          cex=0.5,
          font=1,
          xlab="Age at First Birth", 
          ylab="Age", 
          zlab="Feelings about Life"
)
```-->

```{r, include=FALSE, warning=FALSE, echo=FALSE}
gss <- gss %>% mutate(happy=feelings_life>=6)
gss$feelings_life <- as.factor(gss$feelings_life)
gss.design <- svydesign(data=gss, ids=~1, strata=gss$province, fpc=gss$population)

model <- svyglm(happy ~
                age_at_first_birth +
                age +
                as.factor(income_respondent) +
                as.factor(place_birth_canada) +
                as.factor(future_children_intention),
            gss.design,
            family=quasibinomial
)
```
Using the GSS data, we replicated the approach used in the original survey. A single-stage stratified sampling approach by applying finite population correction to the sample was employed, adjusting each observation by the corresponding provincial population to reduce the variation. Then, we fitted a logistic model to the survey design, yielding the following model:
\begin{align*}
    \log \left(\frac{h}{1-h}\right) =\ &\beta_0 + \beta_1x_1 + \beta_2x_2 \\
    +\ &\underbrace{\beta_{3a}x_{3a} + \beta_{3b}x_{3b} + \beta_{3c}x_{3c} + \beta_{3d}x_{3d} + \beta_{3e}x_{3e}}_{\text{dummy coding for income}} \\
    +\ &\underbrace{\beta_{4a}x_{4a} + \beta_{4b}x_{4b}}_{\text{dummy coding for place birth Canada}} \\
    +\ &\underbrace{\beta_{5a}x_{5a} + \beta_{5b}x_{5b} + \beta_{5c}x_{5c} + \beta_{5d}x_{5d} + \beta_{5e}x_{5e}}_{\text{dummy coding for future children intention}}
\end{align*}
The functional form of the logistic model gives the logarithm of the odds of the outcome variable -- in this case, the binary variable `happy`. For each of the categorical variables in Table 1, we use dummy variable coding with the variable at the top representing the baseline, in order to be able to assess what effect, if any, moving to a category would have compared to the baseline. 

## Results

<!--Here you will include all results. This includes descriptive statistics, graphs, figures, tables, and model results. Please ensure that everything is well formatted and in a report style. You must also provide an explanation of the results in this section. You can overflow to an Appendix if needed. 

Please ensure that everything is well labelled. So if you have multiple histograms and plots, calling them Figure 1, 2, 3, etc. and referencing them as Figure 1, Figure 2, etc. in your report will be expected. The reader should not get lost in a sea of information. Make sure to have the results be clean, well formatted and digestible.-->
The coefficients fitted using the logistic regression model are given in Table 2. The *OR* column gives the odds ratio, *Beta (SE)* gives the logarithm of the odds ratio and corresponding standard error of the estimate. *P* gives the p-value for the significance test which evaluates the probability of encountering data as or more significant than the Wald test statistic.

```{r}
model_summary <- model %>% tabglm(columns=c("or", "beta.se", "p"), latex=T)
rownames(model_summary) <- c(
                             "$\\hfill\\beta_0$",
                             "$\\hfill\\beta_1$",
                             "$\\hfill\\beta_2$",
                             "income cat. var",
                             "income baseline",
                             "$\\hfill\\beta_{3a}$",
                             "$\\hfill\\beta_{3b}$",
                             "$\\hfill\\beta_{3c}$",
                             "$\\hfill\\beta_{3d}$",
                             "$\\hfill\\beta_{3e}$",
                             "birthplace cat. var",
                             "birthplace baseline",
                             "$\\hfill\\beta_{4a}$",
                             "$\\hfill\\beta_{4b}$",
                             "children int. cat. var",
                             "children int. baseline",
                             "$\\hfill\\beta_{5a}$",
                             "$\\hfill\\beta_{5b}$",
                             "$\\hfill\\beta_{5c}$",
                             "$\\hfill\\beta_{5d}$",
                             "$\\hfill\\beta_{5e}$"
)
model_summary$Variable <- model_summary$Variable %>% str_replace_all("_", "\\\\_")
model_summary$Variable <- model_summary$Variable %>% str_replace_all("\\$", "\\\\$")
model_summary %>% kable(row.names=T, escape=F, caption="Logistic Regression Model Summary") %>% kable_styling(latex_options="HOLD_position")
```
The model has the following interpretations:

- The intercept term has no meaningful interpretation and it is statistically significant with a very small p-value.
- The continuous variables `age_at_first_birth`, `age` very slightly affect the model with odds-ratios slightly off from 1.
- The categorical variables `place_birth_canada` and `future_children_intention` make a large difference to the odds ratio with odds-ratios near 0, but this is probably due to a flaw in the survey design which we will discuss in the Weaknesses section of this report.
- `income_respondent` is a meaningful variable in this model. For all six levels, the odds ratio is greater than 1 which implies that each increase in the respondent's income results in an increase in the log odds of being happy compared to the baseline.

Using a variety of parameters with this model, we obtain the following histogram that shows the class distribution of happiness.

```{r, fig.width=10, fig.height=3}
or_probs <- as.data.frame(predict(model, type="response"))
ggplot(or_probs, aes(x=response)) + 
    geom_histogram(bins=30) +
    ggtitle("Predicted Distribution of Happiness") + xlab("Probability of Being Happy")
```

## Discussion

<!--Here you will discuss conclusions drawn from the results and comment on how it relates to the original goal of the study (which was specified in the Introduction).-->



# Weaknesses

<!--Here we discuss weaknesses of the study, data, analysis, etc. You can also discuss areas for improvement.-->

# Next Steps

<!--Here you discuss subsequent work to be done after this report. This can include next steps in terms of statistical analysis (perhaps there is a more efficient algorithm available, or perhaps there is a caveat in the data that would allow for some new technique). Future steps should also be specified in terms of the study setting (eg. including a follow-up survey on something, or a subsequent study that would complement the conclusions of your report).-->



## References

Bibliography:

1. General Social Survey: An Overview, 2019. (2019, February 20). Retrieved October 12, 2020, from Statistics Canada, Canada website:  https://www150.statcan.gc.ca/n1/pub/89f0115x/89f0115x2019001-eng.htm

2. General Social Survey - Family (GSS). (2019, February 7). Retrieved October 12, 2020, from Statistics Canada, Canada website: https://www23.statcan.gc.ca/imdb/p2SV.pl?Function=getSurvey&SDDS=4501

3. Population and Dwelling Count Highlight Tables, 2016 Census. (2019, February 20). Retrieved October 17, 2020, from Statistics Canada, Canada website: https://www12.statcan.gc.ca/census-recensement/2016/dp-pd/hlt-fst/pd-pl/Table.cfm?Lang=Eng&T=101&S=50&O=A

4. Wu, Changbao, and Mary E. Thompson. "Basic Concepts in Survey Sampling." Sampling Theory and Practice. Springer, Cham, 2020. 3-160.